name: Build and Release BoBar

on:
  push:
    tags:
      - 'v*'   # triggers on version tags like v0.1.0

permissions:
  contents: write  # Required to create releases and upload assets

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Publish app (Framework-Dependent)
        run: |
          dotnet publish -c Release -r win-x64 --no-self-contained `
            -p:DebugType=none `
            -p:DebugSymbols=false `
            -o ./publish

      - name: Verify required files
        shell: pwsh
        run: |
          Write-Host "Checking for required files..."
          $requiredFiles = @(
            ".\publish\BoBar.exe",
            ".\publish\default_settings.ini",
            ".\publish\default_launchitems.json"
          )
          foreach ($file in $requiredFiles) {
            if (Test-Path $file) {
              Write-Host "? Found: $file"
            } else {
              Write-Error "? Missing: $file"
              exit 1
            }
          }
          Write-Host "`nAll required files present!"

      - name: Create release archive
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}" -replace '^v', ''
          $archiveName = "BoBar-$version-win-x64.zip"
          Compress-Archive -Path ./publish/* -DestinationPath $archiveName
          Write-Host "Created archive: $archiveName"
          echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_ENV
          echo "VERSION=$version" >> $env:GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: BoBar-win-x64-${{ github.ref_name }}
          path: ${{ env.ARCHIVE_NAME }}
       
      - name: Generate checksum
        shell: pwsh
        run: |
          $hash = Get-FileHash $env:ARCHIVE_NAME -Algorithm SHA256
          Write-Host "SHA256: $($hash.Hash)"
          echo "CHECKSUM=$($hash.Hash)" >> $env:GITHUB_ENV

      - name: Try to get existing draft release
        id: get_release
        uses: cardinalby/git-get-release-action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag: ${{ github.ref_name }}
          draft: true
          doNotFailIfNotFound: true
        continue-on-error: true

      - name: Get previous tag for comparison
        id: previoustag
        shell: pwsh
        run: |
          $currentTag = "${{ github.ref_name }}"
          $previousTag = git describe --tags --abbrev=0 $currentTag^ 2>$null
          if ($LASTEXITCODE -eq 0 -and $previousTag) {
            Write-Host "Previous tag: $previousTag"
            echo "tag=$previousTag" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "No previous tag found"
            echo "tag=" >> $env:GITHUB_OUTPUT
          }

      - name: Generate release notes
        id: release_notes
        shell: pwsh
        run: |
          $version = "${{ env.VERSION }}"
          $previousTag = "${{ steps.previoustag.outputs.tag }}"
          
          # Generate changelog
          $changes = ""
          if ($previousTag) {
            Write-Host "Generating changelog from $previousTag to ${{ github.ref_name }}"
            $commits = git log "$previousTag..${{ github.ref_name }}" --pretty=format:"- %s (%h)" --no-merges
            if ($commits) {
              $changes = $commits -join "`n"
            } else {
              $changes = "- No changes"
            }
          } else {
            $changes = "- Initial release"
          }
          
          # Build release body with template
          $compareLink = if ($previousTag) { "https://github.com/${{ github.repository }}/compare/${previousTag}...${{ github.ref_name }}" } else { "" }
          $compareSection = if ($previousTag) { "- ?? [Compare Changes]($compareLink)" } else { "" }
          
          $body = @"
## What's Changed

$changes

## Installation

1. Download ``BoBar-$version-win-x64.zip`` from the assets below
2. Extract the ZIP file to your desired location
3. Run ``BoBar.exe``

## Requirements

- Windows 10 or later
- [.NET 10.0 Desktop Runtime](https://dotnet.microsoft.com/download/dotnet/10.0)

## Usage Tips

- **First time users**: Right-click the tray icon to access settings
- **Add shortcuts**: Drag & drop ``.exe`` or ``.lnk`` files onto BoBar
- **Move toolbar**: Hold ``Ctrl`` and drag any button
- **Customize**: Right-click ? Settings to edit, reorder, or remove items

## Documentation

- ?? [Full Changelog](https://github.com/${{ github.repository }}/blob/master/CHANGELOG.md)
- ?? [README](https://github.com/${{ github.repository }}/blob/master/README.md)
$compareSection
"@
          
          # Save to output with UTF-8 encoding (no BOM)
          [System.IO.File]::WriteAllText("$PWD/release_notes.md", $body, [System.Text.UTF8Encoding]::new($false))
          echo "generated=true" >> $env:GITHUB_OUTPUT

      - name: Create or Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.ARCHIVE_NAME }}
          draft: false
          prerelease: false
          body_path: ${{ steps.get_release.outputs.body != '' && '' || 'release_notes.md' }}
          body: ${{ steps.get_release.outputs.body }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
